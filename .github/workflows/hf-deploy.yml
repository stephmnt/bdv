name: Deploy to Hugging Face

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deploy dependencies
        run: |
          python -m pip install --upgrade pip
          pip install huggingface_hub

      - name: Upload to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ secrets.HF_REPO }}
        run: |
          if [ -z "$HF_TOKEN" ] || [ -z "$HF_REPO" ]; then
            echo "HF_TOKEN and HF_REPO secrets are required."
            exit 1
          fi
          python - <<'PY'
          import os
          from huggingface_hub import HfApi

          token = os.environ["HF_TOKEN"]
          repo_id = os.environ["HF_REPO"]
          ignore = [
              ".git/**",
              ".github/**",
              ".venv/**",
              "__pycache__/**",
              "notebooks/**",
              "datasets/**",
              "data/raw/**",
              "data/processed/**",
              "data/contours-france-entiere-latest-v2.geojson",
              "data/interim/frames_std/**",
              "data/interim/harmonized/**",
              "data/interim/*.csv",
              "reports/**",
              "output/**",
              "logs/**",
              "catboost_info/**",
              "predictions/**",
              "supports/**",
              "*.ipynb",
          ]
          api = HfApi(token=token)
          api.upload_folder(
              repo_id=repo_id,
              repo_type="space",
              folder_path=".",
              ignore_patterns=ignore,
              commit_message="Sync from GitHub Actions",
          )
          PY
